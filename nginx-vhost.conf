server {
    listen 8080;
    location / {
        try_files $uri @app;
    }
    location @app {
        include uwsgi_params;
        uwsgi_pass unix:///tmp/uwsgi.sock;
    }
    location /static {
        alias /app/iiify/static;
    }

    location ~ /iiif/image/2/(.*)$ {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, PUT, PATCH, DELETE' always;
        add_header 'Access-Control-Expose-Headers' '*' always;

        rewrite ^ $request_uri;
        rewrite ^/iiif/image/2/(.*)$ /iiif/2/$1 break;

        return 400;
        proxy_pass http://${NOMAD_HOST_ADDR_cantaloupe}$uri;
    }

    location ~ /iiif/image/3/(.*)$ {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, PUT, PATCH, DELETE' always;
        add_header 'Access-Control-Expose-Headers' '*' always;

        rewrite ^ $request_uri;
        rewrite ^/iiif/image/3/(.*)$ /iiif/3/$1 break;

        return 400;
        proxy_pass http://${NOMAD_HOST_ADDR_cantaloupe}$uri;
    }
    location ~ /iiif/image/(.*)$ {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, PUT, PATCH, DELETE' always;
        add_header 'Access-Control-Expose-Headers' '*' always;

        rewrite ^ $request_uri;
        rewrite ^/iiif/image/(.*)$ /iiif/3/$1 break;

        return 400;
        proxy_pass http://${NOMAD_HOST_ADDR_cantaloupe}$uri;
    }

}
